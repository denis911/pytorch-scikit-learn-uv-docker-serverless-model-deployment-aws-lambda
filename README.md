# Deploying Scikit-Learn Models to AWS Lambda Using Docker and UV

This repository demonstrates how to train a scikit-learn model for churn prediction, package it in a Docker container using UV for dependency management, and deploy it to AWS Lambda for serverless inference using Docker images and AWS CLI tools.

The project uses UV (a fast Python package installer and resolver) to manage dependencies locally and in the Docker build, ensuring reproducible and efficient deployments.

## ğŸ¯ Overview

This setup provides:
- **Local reproducibility** with UV for dependency management
- **No dependency conflicts** thanks to containerized environments
- **Serverless deployment** on AWS Lambda with Docker containers
- **Automated CI/CD** via deployment scripts
- **Traceable builds** with commit-based tagging

## ğŸ“‹ Prerequisites

- **Operating System**: Windows 11 (tested in VS Code / PowerShell) or Linux/macOS
- **Docker Desktop**: Installed and running
- **AWS CLI v2**: Installed and configured (aws configure or SSO login)
- **Git**: For commit SHA tagging
- **jq**: For JSON parsing (install from https://stedolan.github.io/jq/)
- **Python 3.13+**: For local development
- **UV**: Install via `pip install uv` or from https://github.com/astral-sh/uv
- **AWS Permissions**: Lambda execution role with ECR and CloudWatch access

## ğŸ—‚ï¸ Project Structure

```
pytorch-scikit-learn-uv-docker-serverless-model-deployment-aws-lambda/
â”œâ”€â”€ .dockerignore          # Excludes unnecessary files from Docker build
â”œâ”€â”€ .gitignore             # Git ignore rules for version control
â”œâ”€â”€ .python-version        # Specifies Python version for UV
â”œâ”€â”€ deploy.ps1             # PowerShell script for automated deployment (Windows)
â”œâ”€â”€ deploy.sh              # Bash script for automated deployment (Linux/macOS)
â”œâ”€â”€ Dockerfile             # Defines the Docker image for Lambda container
â”œâ”€â”€ HW9_ONNX_format_for_neural_network_models.ipynb  # Notebook on ONNX format (reference)
â”œâ”€â”€ lambda_function.py     # AWS Lambda handler for model inference
â”œâ”€â”€ local_test.py          # Script to test the model in local Docker container
â”œâ”€â”€ model.bin              # Pickled scikit-learn model (generated by train.py)
â”œâ”€â”€ pyproject.toml         # Project metadata and dependencies (UV format)
â”œâ”€â”€ README.md              # This documentation file
â”œâ”€â”€ requirements.txt       # Exported dependencies from UV (used in Dockerfile)
â”œâ”€â”€ test_lambda.py         # Script to test the deployed Lambda function
â”œâ”€â”€ uv.lock                # UV lock file for reproducible builds
â””â”€â”€ train/                 # Directory for model training
    â””â”€â”€ train.py           # Script to train the churn prediction model
```

## ğŸš€ Quick Start

### 1. Clone and Setup

```bash
git clone https://github.com/denis911/pytorch-scikit-learn-uv-docker-serverless-model-deployment-aws-lambda.git
cd pytorch-scikit-learn-uv-docker-serverless-model-deployment-aws-lambda
uv sync  # Install dependencies locally
```

### 2. Train the Model

Run the training script to generate `model.bin`:

```bash
cd train
python train.py
```

This downloads the Telco Customer Churn dataset, trains a logistic regression pipeline, and saves the model.

### 3. Test Locally

Build and run the Docker container locally:

```bash
docker build -t churn-prediction-lambda .
docker run -it --rm -p 8080:8080 churn-prediction-lambda
```

In another terminal, test the local container:

```bash
python local_test.py
```

Expected output: JSON with churn probability and prediction.

### 4. Deploy to AWS Lambda

#### Using Bash (Linux/macOS):

```bash
chmod +x deploy.sh
./deploy.sh
```

#### Using PowerShell (Windows):

```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
.\deploy.ps1
```

The script will:
- Build the Docker image with a unique tag (commit SHA + timestamp)
- Push to AWS ECR
- Update the Lambda function

### 5. Test Deployed Lambda

Test the deployed function:

```bash
python test_lambda.py
```

## ğŸ“– Detailed Usage

### Training the Model

The `train/train.py` script:
- Loads the Telco Customer Churn dataset from a public URL
- Preprocesses categorical and numerical features
- Trains a scikit-learn pipeline (DictVectorizer + LogisticRegression)
- Saves the model as `model.bin` using pickle

### Docker Build Process

The `Dockerfile`:
- Uses AWS Lambda Python 3.13 base image
- Installs UV
- Copies `pyproject.toml` and `uv.lock`
- Exports dependencies to `requirements.txt`
- Installs dependencies
- Copies `lambda_function.py` and `model.bin`
- Sets the Lambda handler as entrypoint

### Lambda Handler

`lambda_function.py`:
- Loads the pickled model on import
- Expects customer data in the event payload
- Returns churn probability and binary prediction

Input format:
```json
{
  "customer": {
    "gender": "female",
    "seniorcitizen": 0,
    "partner": "yes",
    // ... other features
  }
}
```

Output format:
```json
{
  "churn_probability": 0.123,
  "churn": false
}
```

### Deployment Scripts

- `deploy.sh` / `deploy.ps1`: Automate the build, push, and update process
- Generate unique tags for traceability
- Handle ECR login and Lambda updates

## ğŸ› ï¸ Manual Deployment Steps

If you prefer manual control:

1. **Create ECR Repository** (one-time):
   ```bash
   aws ecr create-repository --repository-name churn-prediction-lambda --region eu-central-1
   ```

2. **Login to ECR**:
   ```bash
   AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq -r ".Account")
   ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.eu-central-1.amazonaws.com"
   aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin "$ECR_URI"
   ```

3. **Build and Push**:
   ```bash
   COMMIT_SHA=$(git rev-parse --short HEAD)
   DATETIME=$(date +"%Y%m%d-%H%M%S")
   IMAGE_TAG="${COMMIT_SHA}-${DATETIME}"
   docker build -t churn-prediction-lambda:"${IMAGE_TAG}" .
   docker tag churn-prediction-lambda:"${IMAGE_TAG}" "${ECR_URI}/churn-prediction-lambda:${IMAGE_TAG}"
   docker push "${ECR_URI}/churn-prediction-lambda:${IMAGE_TAG}"
   ```

4. **Create/Update Lambda**:
   ```bash
   aws lambda create-function \
     --function-name churn-prediction \
     --package-type Image \
     --code ImageUri="${ECR_URI}/churn-prediction-lambda:${IMAGE_TAG}" \
     --role arn:aws:iam::<ACCOUNT_ID>:role/<LAMBDA_EXECUTION_ROLE> \
     --region eu-central-1
   ```

## ğŸ”§ Configuration

- **Region**: Configured for `eu-central-1` (change in scripts if needed)
- **Function Name**: `churn-prediction`
- **Python Version**: 3.13 (Lambda-compatible)
- **Dependencies**: scikit-learn, boto3, requests

## ğŸ“š References

- [AWS Lambda Container Images](https://docs.aws.amazon.com/lambda/latest/dg/images-create.html)
- [AWS ECR Documentation](https://docs.aws.amazon.com/ecr/)
- [AWS CLI v2](https://docs.aws.amazon.com/cli/)
- [UV Package Manager](https://github.com/astral-sh/uv)
- [jq Command Line Tool](https://stedolan.github.io/jq/)
- [Telco Customer Churn Dataset](https://raw.githubusercontent.com/alexeygrigorev/mlbookcamp-code/master/chapter-03-churn-prediction/WA_Fn-UseC_-Telco-Customer-Churn.csv)

---

*This workflow enables continuous deployment of scikit-learn models to AWS Lambda using Docker containers, with full traceability and repeatable builds.*
